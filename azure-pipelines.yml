trigger: none

pool: Hosted Ubuntu 1604

stages:
- stage: Build
  displayName: Build stage
  jobs:  
  - job: Build
    displayName: Build
    pool:
      vmImage: ubuntu-latest
    steps:
    - task: KubernetesManifest@0
      inputs:
        action: 'bake'
        helmChart: 'stable/aerospike'

    - publish: $(System.DefaultWorkingDirectory)/bin/bakedfiles
      artifact: bakedfiles

- stage: Deploy
  displayName: 'Deployment stage'

  jobs:
  - deployment: Deploy
    displayName: Deploy

    environment: 'divman-env.default'
    strategy:
      runOnce:
        deploy:
          steps:
          - task: KubernetesManifest@0
            inputs:
              action: 'deploy'
              kubernetesServiceConnection: 'divman-default'
              strategy: 'canary'
              percentage: '50'
              manifests: '$(System.DefaultWorkingDirectory)/bin/bakedfiles'
              timeout: '0'
              
